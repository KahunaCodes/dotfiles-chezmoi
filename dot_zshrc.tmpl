# ================================================================================
# ZSH Configuration - Managed by Chezmoi
# Machine: {{ .chezmoi.hostname }} | Profile: {{ .profile }}
# ================================================================================

# -------------------------------------------------------------------------------
# PATH Configuration
# -------------------------------------------------------------------------------
export PATH="/opt/homebrew/bin:$PATH"
export PATH="/opt/homebrew/sbin:$PATH"
export PATH="$HOME/.local/bin:$PATH"
export PATH="/usr/local/bin:$PATH"
export PATH="$HOME/bin:$PATH"

{{- if eq .profile "workstation" }}
# Windsurf (if installed)
[[ -d "$HOME/.codeium/windsurf/bin" ]] && export PATH="$HOME/.codeium/windsurf/bin:$PATH"

# -------------------------------------------------------------------------------
# Homebrew
# -------------------------------------------------------------------------------
export HOMEBREW_NO_ANALYTICS=1
if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# -------------------------------------------------------------------------------
# Development Tools
# -------------------------------------------------------------------------------
# NVM (Node Version Manager)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

# pyenv
export PYENV_ROOT="$HOME/.pyenv"
[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
command -v pyenv >/dev/null && eval "$(pyenv init -)"

# uv (modern Python package manager)
eval "$(uv generate-shell-completion zsh)"
export UV_PYTHON_PREFERENCE=managed

# Bun (if installed)
if [[ -d "$HOME/.bun" ]]; then
    export BUN_INSTALL="$HOME/.bun"
    export PATH="$BUN_INSTALL/bin:$PATH"
    [ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"
fi

# -------------------------------------------------------------------------------
# Claude CLI
# -------------------------------------------------------------------------------
export PATH="$HOME/.claude:$PATH"
[[ -f "$HOME/.claude/local/claude" ]] && alias claude="$HOME/.claude/local/claude"
alias cgc='claude --dangerously-skip-permissions "/sc:git --commit"'
alias ci='claude --dangerously-skip-permissions "/init"'
alias csi='claude --dangerously-skip-permissions "/sc:index"'
alias c-dsp='claude --dangerously-skip-permissions'
alias cc-dsp='claude -c --dangerously-skip-permissions'

# -------------------------------------------------------------------------------
# Git Aliases
# -------------------------------------------------------------------------------
alias gs="git status"
alias ga="git add"
alias gc="git commit"
alias gp="git push"
alias gl="git log --oneline --graph --decorate"
alias gd="git diff"
alias gb="git branch"
alias gco="git checkout"
alias gpl="git pull"
alias gf="git fetch"
command -v mgitstatus >/dev/null && alias checkgit="mgitstatus -d 5 -e ~/Projects"

# -------------------------------------------------------------------------------
# Chezmoi
# -------------------------------------------------------------------------------
alias chedit='code $(chezmoi source-path)'

# -------------------------------------------------------------------------------
# Directory Navigation
# -------------------------------------------------------------------------------
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."
alias ~="cd ~"
alias projects="cd ~/Projects"
alias downloads="cd ~/Downloads"
alias desktop="cd ~/Desktop"

# -------------------------------------------------------------------------------
# Common Commands
# -------------------------------------------------------------------------------
alias ll="ls -alh"
alias la="ls -A"
alias l="ls -CF"
alias cls="clear"
alias h="history"
alias path='echo -e ${PATH//:/\\n}'
alias tree="find . -print | sed -e 's;[^/]*/;|____;g;s;____|; |;g'"

# Development
alias ports="lsof -PiTCP -sTCP:LISTEN"
alias ip="curl -s https://api.ipify.org && echo"
alias localip="ipconfig getifaddr en0"

# System
alias reload="source ~/.zshrc"
alias zshconfig="${EDITOR:-code} ~/.zshrc"
alias cpu="top -l 1 | grep 'CPU usage'"
alias mem="top -l 1 | grep PhysMem"
alias authrestart="sudo fdesetup authrestart"
alias unquarantine="xattr -cr"

# -------------------------------------------------------------------------------
# Functions
# -------------------------------------------------------------------------------
mkcd() { mkdir -p "$1" && cd "$1"; }
backup() { cp "$1" "$1.backup-$(date +%Y%m%d-%H%M%S)"; }
hgrep() { history | grep "$1"; }
ff() { find . -name "*$1*"; }
fgrep() { find . -type f -exec grep -l "$1" {} \;; }

newworktree() {
    if [ -z "$1" ]; then
        echo "Usage: newworktree <branch-name>"
        return 1
    fi
    local branch_name="$1"
    local dir_name="${branch_name//\//-}"
    local worktree_path="../${dir_name}"
    if [ -d "$worktree_path" ]; then
        echo "Error: Directory '${worktree_path}' already exists."
        return 1
    fi
    echo "Creating worktree for branch '${branch_name}' at '${worktree_path}'..."
    git worktree add "$worktree_path" -b "$branch_name"
}

# -------------------------------------------------------------------------------
# Environment Variables
# -------------------------------------------------------------------------------
export EDITOR="code"
export VISUAL="code"
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"
export CLICOLOR=1
export LSCOLORS=ExFxBxDxCxegedabagacad

# -------------------------------------------------------------------------------
# History Configuration
# -------------------------------------------------------------------------------
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_VERIFY
setopt SHARE_HISTORY
setopt APPEND_HISTORY
{{- end }}

# -------------------------------------------------------------------------------
# Secrets (loaded from ~/.env if exists)
# -------------------------------------------------------------------------------
[[ -f ~/.env ]] && source ~/.env

# -------------------------------------------------------------------------------
# Warp Terminal Hook
# -------------------------------------------------------------------------------
[[ "$-" == *i* ]] && printf '\eP$f{"hook": "SourcedRcFileForWarp", "value": { "shell": "zsh", "uname": "Darwin" }}\x9c'

# ===== CHEZMOI SYNC FUNCTIONS =====
# Sync chezmoi to all other machines from current machine

chezmoi-sync() {
    local current_host=$(hostname -s)
    local machines=("main-mac" "automation-mac" "away-mac" "hb-mac")
    local failed=()
    
    echo "ðŸ”„ Syncing chezmoi from $current_host to all other machines..."
    
    # First, commit and push local changes if any
    if [[ -d ~/.local/share/chezmoi/.git ]]; then
        cd ~/.local/share/chezmoi
        if [[ -n $(git status --porcelain) ]]; then
            echo "ðŸ“¦ Committing local chezmoi changes..."
            git add -A
            git commit -m "sync: auto-commit from $current_host"
            git push origin main 2>/dev/null || echo "âš ï¸  Push failed, continuing..."
        fi
        cd - > /dev/null
    fi
    
    # Sync to each remote machine
    for machine in "${machines[@]}"; do
        # Skip current machine
        if [[ "$machine" == "$current_host" ]]; then
            continue
        fi
        
        echo ""
        echo "ðŸ“¡ Syncing to $machine..."
        
        # Check if machine is reachable
        if ssh -o ConnectTimeout=3 -o BatchMode=yes "$machine" 'exit 0' 2>/dev/null; then
            if ssh "$machine" '/opt/homebrew/bin/chezmoi update --force 2>&1'; then
                echo "âœ… $machine synced"
            else
                echo "âŒ $machine sync failed"
                failed+=("$machine")
            fi
        else
            echo "â­ï¸  $machine not reachable, skipping"
        fi
    done
    
    echo ""
    if [[ ${#failed[@]} -eq 0 ]]; then
        echo "âœ… All reachable machines synced!"
    else
        echo "âš ï¸  Failed machines: ${failed[*]}"
    fi
}

# Quick alias
alias cz-sync='chezmoi-sync'
alias czs='chezmoi-sync'

# Push local chezmoi changes and sync everywhere
chezmoi-push() {
    echo "ðŸ“¤ Pushing chezmoi changes..."
    cd ~/.local/share/chezmoi
    git add -A
    git commit -m "${1:-sync: manual push}" 2>/dev/null || echo "Nothing to commit"
    git push origin main
    cd - > /dev/null
    chezmoi-sync
}

alias cz-push='chezmoi-push'
alias czp='chezmoi-push'

# Mount shares on hb-mac
alias hb-mount='ssh hb-mac "~/scripts/mount-network-shares.sh && mount | grep smb"'
