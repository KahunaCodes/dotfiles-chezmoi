{{- if and (eq .chezmoi.os "darwin") (eq .chezmoi.username "bgadow") -}}
#!/bin/bash
# Path Finder Settings Sync (bgadow machines only)
# Syncs sidebar favorites, toolbar bookmarks, and preferences
#
# Settings hash: {{ include "private_Library/private_Application Support/private_Path Finder/Settings/settings10" | sha256sum }}

set -e

PF_SUPPORT_DIR="$HOME/Library/Application Support/Path Finder"
PF_PREFS_DIR="$HOME/Library/Preferences"
CHEZMOI_PF_DIR="{{ .chezmoi.sourceDir }}/private_Library/private_Application Support/private_Path Finder"
CHEZMOI_PREFS_PLIST="{{ .chezmoi.sourceDir }}/private_Library/private_Preferences/pathfinder-prefs.plist"

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${GREEN}üîÑ Path Finder Sync${NC}"
echo "   Machine: $(hostname -s)"
echo "   User: $(whoami)"
echo ""

# Check if Path Finder is running
if pgrep -x "Path Finder" > /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Path Finder is running. Killing it first...${NC}"
    pkill -x "Path Finder"
    sleep 2
fi

# Create directories if needed
mkdir -p "$PF_SUPPORT_DIR/Settings"

# Sync SQLite settings database (contains sidebar favorites)
if [ -f "$CHEZMOI_PF_DIR/Settings/settings10" ]; then
    echo "  üì¶ Syncing sidebar favorites (settings10)..."
    cp "$CHEZMOI_PF_DIR/Settings/settings10" "$PF_SUPPORT_DIR/Settings/settings10"
    rm -f "$PF_SUPPORT_DIR/Settings/settings10-shm" "$PF_SUPPORT_DIR/Settings/settings10-wal"
    echo -e "  ${GREEN}‚úì${NC} Sidebar favorites synced"
fi

# Sync preferences plist directly (contains toolbar bookmarks + other prefs)
# Using direct file copy to avoid cfprefsd lock issues
if [ -f "$CHEZMOI_PREFS_PLIST" ]; then
    echo "  üì¶ Syncing preferences (toolbar bookmarks)..."
    cp "$CHEZMOI_PREFS_PLIST" "$PF_PREFS_DIR/com.cocoatech.PathFinder.plist"
    echo -e "  ${GREEN}‚úì${NC} Preferences synced"
fi

# Sync saved searches
if [ -d "$CHEZMOI_PF_DIR/Searches" ]; then
    echo "  üì¶ Syncing saved searches..."
    cp -R "$CHEZMOI_PF_DIR/Searches" "$PF_SUPPORT_DIR/"
    echo -e "  ${GREEN}‚úì${NC} Searches synced"
fi

echo ""
echo -e "${GREEN}‚úÖ Path Finder sync complete!${NC}"
echo "   Launch Path Finder to use synced settings."
{{- else -}}
#!/bin/bash
# Path Finder sync skipped (user={{ .chezmoi.username }}, requires bgadow)
echo "Path Finder sync: skipped (user={{ .chezmoi.username }})"
{{- end -}}
